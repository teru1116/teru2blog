# このアプリケーションについて
フロントエンドにNuxt.js（SPAモード）、バックエンドにFirebaseを用いたブログアプリケーションです。  
データベースはFirestoreを使っています。本番環境とステージング環境とで別々のプロジェクトのFirestoreに繋がります。  
認証はFirebase Authenticationを使っています。管理画面ログインと、チャットで問い合わせしてきた訪問者の識別に使用しています。

# ローカル環境構築
``` bash
# まずは依存パッケージをインストールしてください。
$ yarn install
# localhost:3000でアプリケーションが起動します。ファイルの変更を保存すると即座に反映されます（ホットリロード）。
$ yarn dev
```

# デプロイ
Travis CIを使っているので、デプロイの設定は`.travis.yml`に書かれています。
SPAモードでビルドして、生成された静的ファイル群をFirebase Hostingにホスティングしています。

developブランチにpushすると、プロジェクト`teru2blog-staging`のFirebase Hostingへ、
masterブランチにpushすると、プロジェクト`teru2blog`のFirebase Hostingへデプロイされます。

なお、実行するコマンド毎にNode.jsバージョンを変えています。`yarn install` 時は10.16.0ですが、`yarn build` 時は11.11.0になっています。同じバージョンでビルドした時に失敗したためです。

# 各ページ説明
## フロントページ（ユーザーページ）
一般ユーザーが見るブログサイトです。後述の管理画面から投稿された記事が表示されます。
### トップページ
**新着記事リスト** ストア`articles`を展開しています。
**記事ページ** ストア`article`を展開しています。
**チャット** ストア`messages`を展開しています。  
サイト訪問者にはFirebase Authenticationの匿名認証が行われ、その際に発行された`uid`がチャットルームIDとなります。  
サイト訪問者の匿名認証成功時に、`uid`（=ルームID）を使ってFirestoreにクエリを投げてメッセージを取得し、ストア`messages`に展開しています。
`uid`はメッセージ送信時などで使うため、ストア`me`で保持しています。
### ABOUT
ステージングビルドと本番ビルドとで表示される情報が異なります。
ステージングビルドでは、ポートフォリオ用にGitHubのURLや管理画面のログイン情報を表示しています。
## 管理画面
記事を投稿・編集したり、訪問者のチャットに返信したりできます。
### ログイン
Firebase Authenticationのメールアドレス認証（ `signInWithEmailAndPassword()` メソッド ）を使っています。
### 記事編集
[tiptap](https://github.com/scrumpy/tiptap)というVue.js用のWYSIWYGエディタを使っています。

# ソースコード
## layouts
**admin.vue** 管理画面のヘッダー  
**site.vue** フロントページのヘッダー、チャットのウィジェット、フッター
## middleware
**authAdmin.js** 認証されていない状態で管理画面のログインページ以外にアクセスされた場合、管理画面ログインページにリダイレクトさせています。
**initEditingArticle.js** 管理画面の記事作成ページを開いた時に、ストア `editingArticle` を初期化し、記事IDを生成してストア `editingArticle` にセットしています。
## plugins
**firebase.js** Nuxtアプリ起動時にFirebaseオブジェクトにプロジェクトID等を渡して初期化しています。  
**isMobile.js** スマホ判定を全コンポーネントで行えるよう、 `Vue.prototype` にスマホ判定値をセットしています。

# テスト
## 単体テスト
### Vuex
引数を渡してアクションを実行した結果、ステートが期待通りの値に変わっているかをアサーションしています。  
単体テストというより結合テストと言うべきかもしれません。  
テスト実行時につないでいるFirestoreはステージング環境のそれではありますが、  
Firestoreのデータ変更を伴うようなアクションを実行する場合は、必ずテスト終了時（`afterAll()`など）にその変更をリセットするようにしています。

#### 課題
Firestoreをリッスンするメソッド`onSnapshot()`に関わるテストを書くことができていません。  
他のアクションとは違い、`onSnapshot()`はPromiseではなくコールバックなので `await`演算子での待機ができません。  
タイマーで数秒間待機させるようなテストコードが必要かもしれません。

### コンポーネント

## E2Eテスト
